-- 01 - Criação do BD
create database gatilho;

-- 02 - seta BD
use gatilho;

-- 03 - Table correntista
create table correntista
( IDCO INT auto_increment,
  NOME VARCHAR(50),
  DTHRCAD DATETIME,
  PRIMARY KEY(IDCO));
  
  SELECT * FROM CORRENTISTA;
  
  -- 04 Insert correntista
  insert into correntista(nome, dthrcad)
  values ('Teste Gatilho - 02', now());
  
  -- 05 - Table contacorrentista
  create table contacorrentista
  ( IDCC INT auto_increment,
    IDCO INT,
    NUMEROCONTA INT,
    DTHRINICIO DATETIME,
    DTHRFIM DATETIME,
    PRIMARY KEY(IDCC)
  );
  
  SELECT * FROM CONTACORRENTISTA;
  
  -- 06 - RELACIONAMENTO Correntista x ContaCorrentista
  ALTER TABLE CONTACORRENTISTA
  ADD FOREIGN KEY (IDCO) REFERENCES CORRENTISTA (IDCO);
  
  DESC CONTACORRENTISTA;
  
  -- 07 - ALTER AUTO_INCLEMENTE
  ALTER TABLE CONTACORRENTISTA
  auto_increment = 1968;
  
  -- 08 - DESC COTACORRENTISTA
  DESC CONTACORRENTISTA;
  
  -- 09 INSERT CONTACORRENTISTA
  INSERT INTO CONTACORRENTISTA (IDCO,NUMEROCONTA, DTHRINICIO, DTHRFIM)
  VALUES (1,2020,NOW(),NULL);
  
  SELECT * FROM CORRENTISTA, CONTACORRENTISTA
  WHERE CORRENTISTA.IDCO = CONTACORRENTISTA.IDCO;
  
  SELECT * FROM CONTACORRENTISTA;
  
  DELIMITER $$
CREATE FUNCTION FC_NUMEROCONTA()
RETURNS INT
deterministic
BEGIN

 -- VARIÁVEL
 DECLARE CODIGO, NOME, NUMERO INT;
 
 
 -- SELECIONA CORRENTISTA
 SET CODIGO = (SELECT MAX(IDCO)
 FROM CORRENTISTA);
 
 -- SELECIONE NÚMERO
 SET NUMERO = (CODIGO)+(10000)+(SELECT YEAR(NOW()));
 
 RETURN (NUMERO);
 
 END $$
 
 DELIMITER ;
 
 DELIMITER // 
 CREATE TRIGGER TG_ADICIONA_CONTA
 AFTER INSERT ON CORRENTISTA
 FOR EACH ROW
 BEGIN
 
  -- VARIÁVEL
  DECLARE CODIGO INT;
  
  -- SELECIONE CORRENTISTA
  SET CODIGO = (SELECT MAX(IDCO)
  FROM CORRENTISTA);
  
  -- INSERT CONTACORRENTISTA
  INSERT INTO CONTACORRENTISTA (IDCO, NUMEROCONTA, DTHRINICIO, DTHRFIM)
  VALUES (CODIGO,FC_NUMEROCONTA(),NOW(),NULL);
  
  END